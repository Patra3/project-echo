// revision: 12/18/2024 at 6:01PM
function gebi(e){return document.getElementById(e)}function openLoading(){gebi("loading_overlay").style.display="block"}function closeLoading(){gebi("loading_overlay").style.display="none"}let cef,cvf;function updateTasksWithView(){const e=performance.now();let t;request(["fetchTasksWithView",sessionToken,window.currentGroup.groupid,cvf.taskviewid]).then((async a=>{if(t=performance.now(),"OK"==a.status){let e={};a.data.forEach((t=>{Object.hasOwn(e,t.taskid)||(e[t.taskid]=[]),e[t.taskid].push(t.tagid)}));for(let t in e)e[t]=e[t].map((e=>{let t=window.currentGroup.tags;for(let a in t)if(t[a].tagid==e)return t[a]}));if(window.data.tasks.forEach(((t,a)=>{Object.hasOwn(e,t.taskid)&&(window.data.tasks[a].tags=e[t.taskid])})),!showArchived){let e=window.data.tasks;for(let t=e.length-1;t>=0;t--)null!=e[t].completeddate&&e.splice(t,1)}let t=window.data.tasks;for(let e=t.length-1;e>=0;e--)t[e].groupid!=currentVaultId&&t.splice(e,1);t=window.data.tasks;let n=null==cvf.descincludes?"":cvf.descincludes,r=null==cvf.titleincludes?"":cvf.titleincludes,o=[];o=cvf.tagincludes.includes(",")?cvf.tagincludes.split(",").map((e=>parseInt(e))):cvf.tagincludes.length>0?parseInt(cvf.tagincludes)+"":"",console.log("ARGGG: "+o);let i=window.data.tasks;for(let e=i.length-1;e>=0;e--)if(n.length>0)i[e].description.includes(n)&&i.splice(e,1);else if(r.length>0)i[e].taskname.includes(r)||i.splice(e,1);else if(o.length>0){let t=!1;if(Object.hasOwn(i[e],"tags")){i[e].tags.map((e=>e.tagid)).forEach((e=>{o.includes(e)&&(t=!0)}))}t||i.splice(e,1)}let s={},l=cvf.groupby;"day"==l?i.forEach((e=>{let t,a=e.duedate;t=null!=a&&""!=a?new Date(e.duedate):new Date(e.createddate);let n=t.toLocaleDateString(options={weekday:"narrow",year:"2-digit",month:"short",day:"numeric",dateStyle:"short"});Object.hasOwn(s,n)||(s[n]=[]),s[n].push(e)})):"week"==l?i.forEach((e=>{let t,a=e.duedate;t=null!=a&&""!=a?new Date(e.duedate):new Date(e.createddate);let n=`${new Date(startOfWeek(t)).toLocaleDateString()} - ${new Date(endOfWeek(t)).toLocaleDateString()}`;Object.hasOwn(s,n)||(s[n]=[]),s[n].push(e)})):"month"==l?i.forEach((e=>{let t,a=e.duedate;t=null!=a&&""!=a?new Date(e.duedate):new Date(e.createddate);let n=`${t.toLocaleString("default",{month:"long"})} ${t.getFullYear()}`;Object.hasOwn(s,n)||(s[n]=[]),s[n].push(e)})):"year"==l&&i.forEach((e=>{let t,a=e.duedate;t=null!=a&&""!=a?new Date(e.duedate):new Date(e.createddate);let n=`${t.getFullYear()}`;Object.hasOwn(s,n)||(s[n]=[]),s[n].push(e)}));let d=cvf.sortby;for(let e in s)"priority"==d?s[e].sort(((e,t)=>t.priority-e.priority)):"title"==d?s[e].sort(((e,t)=>e.taskname<t.taskname?-1:1)):"duedate"==d&&s[e].sort(((e,t)=>{let a,n;return a=null!=e.duedate&&""!=e.duedate?new Date(e.duedate):new Date(e.createddate),n=null!=t.duedate&&""!=t.duedate?new Date(t.duedate):new Date(t.createddate),a<n?-1:1}));console.log(s);let c=gebi("tasks-list");c.innerHTML="";let u=Object.keys(s);u.sort(((e,t)=>compareDesc(t,e)));for(let e=0;e<u.length;e++){let t=u[e],a=[];for(let e=0;e<s[t].length;e++){let n=s[t][e],r="",o="";if(null!=n.duedate&&""!=n.duedate)try{o=new Date(n.duedate).toLocaleString(),r+="Due "+intlFormatDistance(new Date(n.duedate),new Date)}catch(e){location.reload()}else r+="Created "+new Date(n.createddate).toLocaleString();let i="",l="",d="",c="",u="";null==n.completeddate?(i="circle",l="orange",c="hidden",u=`markComplete(${n.taskid})`):(i="check",l="green",d="hidden",u=`markIncomplete(${n.taskid})`);let g="";Object.hasOwn(n,"tags")&&n.tags.forEach((e=>{g+=`\n                                  <span class="task-mini-tag" style="${isLightColor(e.tagcolor)?"color: black;":"color: white;"}background-color: ${e.tagcolor};border-color: ${darkenHexColor(e.tagcolor,50)};">#${e.tagname}</span>\n                                `})),a.push(`\n                              <br>\n                              <div class="card">\n                                <div class="card-body">\n                                  ${g}\n                                  <div class="row" style="${Object.hasOwn(n,"tags")&&n.tags.length>0?"margin-top: 20px;":""} margin-bottom: 5px;">\n                                    <div class="col-6" style="font-family: 'DM Mono', monospace;">\n                                      <h5 style="padding:0;margin:0;"><i onclick="${u}" data-feather="${i}" style="color: ${l};cursor:pointer;"></i>&nbsp;&nbsp;&nbsp;${n.taskname}</h5>\n                                    </div>\n                                    <div class="col-6"><i style="color: darkred;" title="Delete" onclick="deleteTask(${n.taskid})" data-feather="trash" class="tricon"></i><i style="color: green;" onclick="dlAttachments(${n.attachmentid})" data-feather="download" class="tricon" ${null==n.attachmentid?"hidden":""}></i><i onclick="editTask(${n.taskid})" data-feather="edit" class="tricon"></i></div>\n                                  </div>\n                                  <span style="font-size: 0.91rem; font-family: 'DM Mono', monospace;">${o}</span>\n                                  <p style="font-size: 0.80rem; font-family: 'DM Mono', monospace;${r.includes("ago")?"color: darkred;":""}">${r}</p>\n                                  <div class="task-itm-desc container" id="task-sb${n.taskid}" style="width: 100%;">${DOMPurify.sanitize(marked.parse(n.description))}</div>\n                                </div>\n                              </div>\n                            `)}let n=t;t.includes("/")&&!t.includes("-")&&(t=intlFormatDistance(t,new Date,{unit:"day"}),t+=" ("+n+")",t=t[0].toUpperCase()+t.substring(1));let r=`\n                            <h5 style="color: black; padding: 10px; border-radius: 10px; font-family: 'DM Mono', monospace;">${t}</h5>\n                            <hr>\n                            <div class="container">${a.join("")}</div><br><br><br>\n                          `;c.innerHTML+="<br><br>"+r,feather.replace();let o=document.getElementsByClassName("task-itm-desc");for(let e=0;e<o.length;e++){let t=o[e].getElementsByTagName("*");for(let e=0;e<t.length;e++){let a=t[e];"IMG"==a.tagName&&(a.style="width: 100%; border-radius: 5px; cursor: pointer;",a.onclick=()=>{let e=a.getAttribute("src");window.open(e,"_blank")})}}}}const n=performance.now();console.log("Task Fetch-Draw performance-"),console.log(`Client rendering time: ${(n-t).toFixed(3)}ms`),console.log(`Request-to-response performace time: ${(t-e).toFixed(3)}ms`),console.log(`%cRequest-to-finish time: ${(n-e).toFixed(3)}ms`,"color: green;")}))}function markComplete(e){request(["mark",sessionToken,!0,e]).then((e=>{"OK"!=e.status?(alert("An error has occured."),console.log(e)):location.reload()}))}function markIncomplete(e){request(["mark",sessionToken,!1,e]).then((e=>{"OK"!=e.status?(alert("An error has occured."),console.log(e)):location.reload()}))}function editTask(e){pauseScan=!0;let t=gebi("taskEditorOffcanvas"),a=new bootstrap.Offcanvas(t),n=gebi("task-name"),r=gebi("task-duedate"),o=gebi("task-priority");gebi("task-attachments").value="",gebi("task-editor-btn").innerHTML="Edit Task",t.setAttribute("data-idd",e),window.data.tasks.forEach((t=>{if(t.taskid==e){if(n.value=t.taskname,taskDescription.value(t.description),null!=t.duedate){let e=new Date(t.duedate);e.setMinutes(e.getMinutes()-e.getTimezoneOffset()),r.value=e.toISOString().slice(0,16)}else r.value=null;if(o.value=t.priority,Object.hasOwn(t,"tags")){let e=t.tags.map((e=>e.tagid));window.currentGroup.tags.forEach((t=>{let a=gebi(`task-tag-number${t.tagid}`);e.includes(t.tagid)?null!=a&&(a.checked=!0):null!=a&&(a.checked=!1)}))}}})),t.addEventListener("hide.bs.offcanvas",(()=>{t.removeAttribute("data-idd"),window.currentGroup.tags.forEach((e=>{let t=gebi(`task-tag-number${e.tagid}`);null!=t&&(t.checked=!1),n.value="",taskDescription.value(""),r.value=null,gebi("task-attachments").value="",o.value=1})),pauseScan=!1}),{once:!0}),a.toggle()}let state=!1;function deleteTask(e){confirm("Are you certain you wish to delete this task?")?request(["deleteTask",sessionToken,e]).then((e=>{"OK"==e.status||alert("An error has occurred."),location.reload()})):alert("Nothing was deleted.")}function dlAttachments(e){request(["dl",sessionToken,e]).then((e=>{if("OK"==e.status){let t=gebi("dldl");t.action=`/api/${JSON.stringify(["serv",sessionToken,e.serveId])}`,t.method="post",t.target="_blank",t.setAttribute("download",e.serveId),t.submit()}else alert("An error has occurred."),console.log(e)}))}function sendMsg(e){alert(e)}function updateFilterPage(){if(window.currentGroup.filters.push({descincludes:null,enddate:null,filtername:"Add new filter",groupby:"day",sortby:"duedate",startdate:null,tagincludes:"",tagquery:null,taskviewid:-1,titleincludes:null,isnotdone:!0,isdone:!1,vaultid:window.currentGroup.groupid}),window.currentGroup.filters.forEach((e=>{"Default"===e.filtername&&(cef=e)})),cvf=storage.read("cvf"),-1==cvf)cvf=window.currentGroup.filters[0];else{let e=!1;window.currentGroup.filters.forEach((t=>{t.taskviewid==cvf.taskviewid&&(e=!0,cvf=t,storage.write("cvf",t))})),e||(cvf=window.currentGroup.filters[0],storage.write("cvf",cvf))}cef||(cef=window.currentGroup.filters[0]),updateTasksWithView();let e=gebi("filters-edit-list");e.innerHTML="";let t=gebi("taskview-filter");t.innerHTML="",window.currentGroup.filters.forEach((a=>{let n=document.createElement("LI");if(n.innerHTML=`\n                        <a class="dropdown-item">${a.filtername}</a>\n                      `,n.onclick=()=>{cef=a,updateFilterForm()},n.style.cursor="pointer",e.appendChild(n),"Add new filter"!=a.filtername){let e=document.createElement("OPTION");a.taskviewid===cvf.taskviewid&&e.setAttribute("selected",""),e.value=a.taskviewid,e.innerHTML=a.filtername,t.innerHTML+=e.outerHTML}})),1!==window.currentGroup.filters.length?updateFilterForm():request(["updateFilter",sessionToken],!0,{filterId:-1,filterName:"Default",vaultid:window.currentGroup.groupid,sortBy:"duedate",groupBy:"day",descincludes:null,titleincludes:null,tagincludes:"",isdone:!1,isnotdone:!0,startdate:null,enddate:null}).then((e=>{location.reload()}))}function updateFilterForm(){gebi("filter-title").innerHTML=`Editing <b>${-1===cef.taskviewid?"New":cef.filtername}</b> filter`;let e=gebi("filter-name");-1!==cef.taskviewid?(e.value=cef.filtername,e.placeholder=""):(e.value="",e.placeholder="Filter name"),gebi("filter-groupby").value=cef.groupby,gebi("filter-sortby").value=cef.sortby,gebi("filter-descincludes").value=cef.descincludes,gebi("filter-titleincludes").value=cef.titleincludes;let t=gebi("filter-startdate"),a=gebi("filter-enddate");null!=cef.startdate?t.value=new Date(cef.startdate).toISOString().slice(0,16):t.value="",null!=cef.enddate?a.value=new Date(cef.enddate).toISOString().slice(0,16):a.value="";let n=gebi("filter-isdone"),r=gebi("filter-isnotdone");cef.isdone?n.checked=!0:n.checked=!1,cef.isnotdone?r.checked=!0:r.checked=!1;let o=[];cef.tagincludes.split(",").forEach((e=>{o.push(parseInt(e));let t=gebi(`filter-tag-number${e}`);t||null==t?null!=t&&(t.checked=!0):updateCurrentFilter()})),window.currentGroup.tags.forEach((e=>{let t=gebi(`filter-tag-number${e.tagid}`);o.includes(parseInt(e.tagid))&&0!=cef.tagincludes.length||(t.checked=!1)}))}function updateCurrentFilter(){console.log(FormHero.extractFormContent("filter-form"));let e=FormHero.extractFormContent("filter-form");if(""==e.startdate&&(e.startdate=null),""==e.enddate&&(e.enddate=null),!e.isdone&&!e.isnotdone)return void alert('At least one, "Is Done" or "Is Not Done", must be selected.');let t={filterId:cef.taskviewid,filterName:e.name,vaultid:window.currentGroup.groupid,sortBy:e.sortby,groupBy:e.groupby,descincludes:e.descincludes,titleincludes:e.titleincludes,tagincludes:e.checkedTagIds,isdone:e.isdone,isnotdone:e.isnotdone,startdate:e.startdate,enddate:e.enddate};console.log(t),request(["updateFilter",sessionToken],!0,t).then((e=>{"OK"==e.status||alert("An error has occurred."),location.reload()}))}function deleteFilter(){2!=window.currentGroup.filters.length?confirm("Are you certain you want to delete?")?request(["deleteFilter",sessionToken,cef.taskviewid]).then((e=>{"OK"===e.status&&(alert(`Successfully deleted ${cef.filtername} filter.`),location.reload())})):alert("Nothing has been deleted."):alert("You cannot delete the last filter. Please make another filter before deleting this one.")}function changeUsername(){let e=prompt("Enter new username: ");null!=e&&e.length>=1&&request(["editUser",sessionToken],!0,{passwordhash:null,salt:null,username:e,hex:null,ext:null}).then((e=>{"OK"==e.status||alert("An error has occurred."),location.reload()}))}async function changePassword(){let e=gebi("password-1"),t=gebi("password-2"),a=e.value,n=t.value;if(null!=a&&a.length>6&&null!=n&&n.length>6)if(a==n){let e=Buffer.from(crypto.getRandomValues(new Uint8Array(8))).toString("hex");const t=Buffer.from(new Uint8Array(await window.crypto.subtle.digest("SHA-512",(new TextEncoder).encode(a+e)))).toString("hex");request(["editUser",sessionToken],!0,{passwordhash:t,passwordsalt:e,username:null,hex:null,ext:null}).then((e=>{"OK"==e.status?location.reload():(alert("An error has occurred."),console.log(e))}))}else alert("Passwords do not match, please try again.");else alert("Password must be >6 characters, invalid input.")}function uploadPfp(){let e=document.createElement("input");e.type="file",e.onchange=t=>{console.log(e.files);let a=new FileReader,n=e.files[0];function r(e){alert(`Error reading file ${n.name}, skipping file.`),console.error(e)}a.onerror=r,a.onabort=r,a.onloadend=e=>{let t=["image/apng","image/gif","image/jpeg","image/png","image/svg+xml","image/webp"],r=n.type;t.includes(r)?request(["editUser",sessionToken],!0,{passwordhash:null,salt:null,username:null,hex:Buffer.from(new Uint8Array(a.result)).toString("hex"),ext:n.type.replace("image/","")}).then((e=>{"OK"==e.status||alert("An error has occurred."),location.reload()})):alert("Invalid image type. Must be of type(s): "+t.map((e=>e.replace("image/",""))).join(", "))},a.readAsArrayBuffer(n)},e.click()}function darkenHexColor(e,t=20){e=e.replace("#","");let a=parseInt(e.substring(0,2),16),n=parseInt(e.substring(2,4),16),r=parseInt(e.substring(4,6),16);return a=Math.max(a-t,0),n=Math.max(n-t,0),r=Math.max(r-t,0),`#${a.toString(16).padStart(2,"0")}${n.toString(16).padStart(2,"0")}${r.toString(16).padStart(2,"0")}`}window.addEventListener("load",(function(){window.pauseScan=!1,gebi("taskEditorOffcanvas").addEventListener("show.bs.offcanvas",(()=>{state=!0,pauseScan=!0})),gebi("taskEditorOffcanvas").addEventListener("hide.bs.offcanvas",(()=>{state=!1,pauseScan=!1})),window.setInterval((()=>{if(!pauseScan){let e=gebi("taskEditorOffcanvas");new bootstrap.Offcanvas(e);if(!state){e.hasAttribute("data-idd")&&e.removeAttribute("data-idd"),gebi("task-editor-btn").innerHTML="Create Task";let t=gebi("task-name"),a=gebi("task-duedate"),n=gebi("task-priority");window.currentGroup.tags.forEach((e=>{let t=gebi(`task-tag-number${e.tagid}`);null!=t&&(t.checked=!1)})),t.value="",taskDescription.value(""),a.value=null,gebi("task-attachments").value="",n.value=1}}}),1e3)}));let storage={write:(e,t)=>{localStorage.setItem(e,JSON.stringify([t]))},read:e=>null==localStorage.getItem(e)?-1:JSON.parse(localStorage.getItem(e))[0],delete:e=>{localStorage.removeItem(e)},clear:()=>{localStorage.clear()}};const nanoid=(e=21)=>{let t="",a=crypto.getRandomValues(new Uint8Array(e));for(let n=0;n<e;n++)t+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&a[n]];return t};Coloris({themeMode:"pill",alpha:!1}),feather.replace(),window.setInterval((()=>{let e=new Date,t=gebi("clock-statement");window.data&&(t.innerHTML=`${e.toLocaleString()} (${window.data.tasks.length} tasks)`),0==e.getSeconds()&&updateTasksWithView()}),1e3);let FormHero={extractFormContent:e=>{let t=gebi(e).getElementsByTagName("*"),a={checkedTagIds:[]};for(let e of t)if("INPUT"===e.tagName){let t=e.id,n=e.name,r=e.value;t.includes("tag-number")&&e.checked&&a.checkedTagIds.push(parseInt(t.split("-")[2].replace("number",""))),"checkbox"==e.type&&(r=e.checked),n?a[n.split("-")[1]]=r:a[t.split("-")[1]]=r}else"SELECT"===e.tagName&&(a[e.id.split("-")[1]]=e.value);return delete a.tag,a}},abcba=gebi("taskview-showarchived");window.showArchived=storage.read("showarchived"),-1!=window.showArchived?abcba.checked=window.showArchived:window.showArchived=abcba.checked;const Buffer=window.Buffer.Buffer;let currentPage="auth",abcbc=gebi("taskview-filter");function changePage(e){currentPage!=e&&("main-view"!=currentPage&&(gebi(currentPage).style.display="none"),gebi(e).style.display="block",e.includes("view")&&(gebi(`${currentPage}-item`).classList.remove("active"),gebi(`${e}-item`).classList.add("active"),location.hash=e),currentPage=e)}abcbc.onchange=()=>{let e=parseInt(abcbc.value);window.currentGroup.filters.forEach((t=>{t.taskviewid===e&&(cvf=t,storage.write("cvf",cvf))}))},abcba.onchange=()=>{window.showArchived=!window.showArchived,storage.write("showarchived",window.showArchived),abcba.checked=window.showArchived,refreshClient(),updateTasksWithView()};let sessionToken=storage.read("sessionToken"),currentVaultId=storage.read("currentVaultId"),uid=-1;if(-1!=sessionToken){changePage("main-page"),currentPage="tasks-view";let e=location.hash.substring(1);null!=gebi(`${e}`)&&changePage(e),refreshClient()}function addPersonToVault(e){let t=prompt("Please enter their user code: ");null!=t&&21==t.length?request(["addUserToGroup",sessionToken,t,e]).then((e=>{"OK"==e.status?location.reload():"USERNOTFOUND"==e.status?alert("Invalid user code."):"INGROUP"==e.status?alert("User is already in this vault."):alert("An error has occurred.")})):alert("Invalid user code.")}function createNewUser(){let e=prompt("Please enter a username: ");null!=e&&e.length>=1?request(["createNewUser",sessionToken,e]).then((t=>{"OK"==t.status?(navigator.clipboard.writeText(t.password),alert(`User ${e} has been created with password: ${t.password} (copied to clipboard)`)):"USEREXISTS"==t.status?alert("Username already exists."):(alert("An error has occurred."),location.reload())})):alert("Invalid username, user not created.")}function createNewGroup(){let e=prompt("Enter your new vault name: ");null!=e&&""!=e.length&&request(["createNewGroup",sessionToken,e]).then((e=>{"OK"==e.status||alert("An error has occurred."),location.reload()}))}function createNewTask(){let e=!1,t=-1,a=gebi("taskEditorOffcanvas");a.hasAttribute("data-idd")&&(e=!0,t=parseInt(a.getAttribute("data-idd")));let n=gebi("task-name").value,r=taskDescription.value(),o=gebi("task-duedate").value,i=gebi("task-priority").value,s=gebi("task-attachments").files;console.log(s);let l={};o||(o=null);let d=window.setInterval((()=>{if(Object.keys(l).length==Object.keys(s).length){console.log(l);let a=window.currentTags.map((e=>e.tagid)),s=[];if(a.forEach((e=>{gebi(`task-tag-number${e}`).checked&&s.push(e)})),e){let e=new Date(o).toISOString();null==o&&(e=null),request(["updateTask",sessionToken,n,e,i,t],!0,{tags:s,attachments:l,desc:r,groupid:window.currentGroup.groupid}).then((e=>{"OK"==e.status?(console.log(s),location.reload()):(alert("An error has occurred while creating this task."),console.log(window.data),location.reload())}))}else{let e=new Date(o).toISOString();null==o&&(e=null),request(["createNewTask",sessionToken,n,e,i],!0,{tags:s,attachments:l,desc:r,groupid:window.currentGroup.groupid}).then((e=>{console.log(e),"OK"==e.status||alert("An error has occurred while creating this task."),location.reload()}))}window.clearInterval(d)}}),200);Object.keys(s).forEach((e=>{let t=new FileReader,a=s[e];function n(e){alert(`Error reading file ${a.name}, skipping file.`),console.error(e)}t.onerror=n,t.onabort=n,t.onloadend=e=>{l[a.name]={lastModified:a.lastModified,size:a.size,type:a.type,hexData:Buffer.from(new Uint8Array(t.result)).toString("hex")}},t.readAsArrayBuffer(a)}))}function createNewTag(){let e=gebi("tag-name"),t=gebi("tag-color");request(["createNewTag",sessionToken,currentVaultId,e.value,t.value]).then((a=>{e.value="",t.value="","ERROR"===a.status||"INVALID"===a.status?(alert("An error has occurred. The app will restart now."),storage.clear(),location.reload()):refreshClient()}))}function deleteTag(e,t=!1){let a=!1;a=t?"delete all"===window.prompt('Please enter "delete all" to confirm.'):"delete"===window.prompt('Please enter "delete" to confirm.'),a?request(["deleteTag",sessionToken,e,t]).then((e=>{"ERROR"!=e.status&&"INVALID"!=e.status||(alert("An error has occurred. The app will restart now."),storage.clear()),location.reload()})):alert("Nothing was deleted.")}function editTag(){if(null==currentEditingTag)location.reload();else{let e=currentEditingTag;currentEditingTag=null;let t=gebi("tag2-name").value,a=gebi("tag2-color").value;request(["updateTag",sessionToken,e,t,a]).then((e=>{"ERROR"!=e.status&&"INVALID"!=e.status||(alert("An error has occurred. The app will restart now."),storage.clear()),location.reload()}))}}function isLightColor(e){if(7==e.length){const t=[parseInt(e.substring(1,3),16),parseInt(e.substring(3,5),16),parseInt(e.substring(5),16)];return.2126*t[0]/255+.7152*t[1]/255+.0722*t[2]/255>.5}return!1}function gotoVault(e){window.data.groups.forEach((t=>{t.groupid==e&&(window.currentGroup=t,storage.write("currentVaultId",e),location.reload())}))}function editVault(e){let t=prompt("Enter new vault name: ");null!=t&&0!=t.length&&request(["updateGroupName",sessionToken,e,t]).then((e=>{"OK"==e.status?location.reload():"INVALID"==e.status?alert("You do not have permission to perform this action."):"ERROR"==e.status&&(alert("An error has occurred while performing this action."),location.reload())}))}function deleteVault(e){let t;window.data.groups.forEach((a=>{a.groupid==e&&(t=a.groupname)})),prompt(`Please type ${t} to confirm you want to delete.`)!=t?alert("Nothing was deleted."):request(["deleteGroup",sessionToken,e]).then((e=>{"OK"==e.status?location.reload():"CANNOTDELETE"==e.status?alert("Cannot delete your last vault."):"INVALID"==e.status?(alert("You do not have permission to perform this action."),location.reload()):alert("An error has occurred.")}))}function removeUserFromGroup(e){request(["removeUser",sessionToken,e,window.currentGroup.groupid]).then((e=>{"OK"==e.status||alert("An error has occurred."),location.reload()}))}function refreshClient(){let e=performance.now();request(["getClientPackageUpdate",sessionToken]).then((t=>{let a=performance.now();if("INVALID"===t.status)storage.clear(),location.reload();else{window.data=t,uid=t.me.userid;let n=t.me.pfp;console.log(t);let r=`data:image/${n.fileName.split(".")[1]};base64,${Buffer.from(n.hexData,"hex").toString("base64")}`,o=document.getElementsByClassName("self-pfp");for(let e=0;e<o.length;e++){o[e].src=r}if(-1===currentVaultId)currentVaultId=t.groups[0].groupid,window.currentGroup=t.groups[0],storage.write("currentVaultId",currentVaultId);else{for(let e=0;e<t.groups.length;e++)t.groups[e].groupid==currentVaultId&&(window.currentGroup=t.groups[e]);void 0===window.currentGroup&&(currentVaultId=t.groups[0].groupid,window.currentGroup=t.groups[0],storage.write("currentVaultId",currentVaultId))}let i="";window.currentGroup.users.forEach((e=>{let t=e.pfp,a=`data:image/${t.fileName.split(".")[1]};base64,${Buffer.from(t.hexData,"hex").toString("base64")}`,n=`\n            <br>\n              <div class="card">\n                <div class="card-body">\n                  <div class="row">\n                    <div class="col-10">\n                      <h5>${e.username} &nbsp;<span style="background-color:lightblue;padding:5px;border-radius:25px;font-size:12px;" ${window.currentGroup.adminid==e.userid?"":"hidden"}>Owner</span></h5>\n                    </div>\n                    <div class="col-2">\n                      <img src="${a}" style="float: right; height: 2rem; border-radius: 50px;">\n                    </div>\n                  </div>\n                </div>\n                <div class="card-footer" ${e.userid==window.currentGroup.adminid?"hidden":""}>\n                  <button onclick="removeUserFromGroup('${e.userid}')" type="button" class="btn btn-outline-danger">Remove</button>\n                </div>\n              </div>\n            `;i+=n})),gebi("people-list").innerHTML=i;let s=gebi("profile-view-item");s.addEventListener("mouseover",(()=>{gebi("greeting").innerHTML="My Profile"})),s.addEventListener("mouseout",(()=>{gebi("greeting").innerHTML=`Hi, ${t.me.username}`})),gebi("greeting").innerHTML=`Hi, ${t.me.username}`;let l=gebi("vaults");l.innerHTML="",t.groups.forEach((e=>{let t=document.createElement("div");currentVaultId===e.groupid&&(window.currentGroup=e);let a=0;window.data.tasks.forEach((t=>{null==t.completeddate&&t.groupid==e.groupid&&a++})),t.innerHTML=`<br>\n                <div class="card">\n                  <div class="card-body" data-groupid="${e.groupid}">\n                    <h5 class="card-title">${e.groupname}&nbsp;<span style="float:right;border:2px solid;padding:3px;border-radius:25px;font-size:12px;" ${e.adminid==window.data.me.userid?"":"hidden"}>Your vault</span>&nbsp;<span style="margin-left:5px;margin-right:5px;float:right;background-color:lightgreen;padding:5px;border-radius:25px;font-size:12px;" ${currentVaultId===e.groupid?"":"hidden"}>Viewing</span></h5>\n                    <small style="font-family: 'DM Mono', monospace;">\n                    <i data-feather="users" style="width: 1rem;"></i> ${e.users.length} ${1==e.users.length?"person":"people"}\n                    &nbsp;\n                    <i data-feather="check-circle" style="width: 1rem;"></i> ${a} tasks\n                    &nbsp;\n                    </small>\n                  </div>\n                  <div class="card-footer" ${currentVaultId===e.groupid&&e.adminid!==uid&&e.adminid!==uid?"hidden":""}>\n                    <button onclick="gotoVault(${e.groupid})" type="button" class="btn btn-primary" style="display:${currentVaultId===e.groupid?"none":"inline"};">Go to vault</button>\n                    <button onclick="editVault(${e.groupid})" type="button" class="btn btn-secondary" style="display:${e.adminid===uid?"inline":"none"};">Edit vault</button>\n                    <button onclick="deleteVault(${e.groupid})" type="button" class="btn btn-danger" style="display:${e.adminid===uid?"inline":"none"};">Delete vault</button>\n                  </div>\n                </div>\n            `,l.appendChild(t),feather.replace()}));let d=gebi("tag-editor-list");d.innerHTML="",window.currentTags=window.currentGroup.tags,console.log(window.currentTags);let c=gebi("task-tags");c.innerHTML="";let u=gebi("filter-tags");u.innerHTML="",0===window.currentTags.length?(c.innerHTML='<div class="container">No tags found</div>',u.innerHTML='<div class="container">No tags found</div>'):(window.currentTags.forEach((e=>{let t=document.createElement("div");t.innerHTML=`<button onclick="renderTagEditor(this.dataset.tagid)" data-tagid="${e.tagid}" type="button" class="btn w-100" style="border-radius:0;background-color: ${e.tagcolor};${isLightColor(e.tagcolor)?"color: black;":"color: white;"}">${e.tagname}</button>`,d.appendChild(t),t=document.createElement("div"),t.classList="col",t.innerHTML=`\n                <input type="checkbox" class="checkbox-round" id="task-tag-number${e.tagid}" name="task-tag-number${e.tagid}" value="${e.tagname}">\n                <label for="task-tag-number${e.tagid}" style="margin-top:5px;white-space:nowrap;cursor:pointer;padding:0.25rem;padding-left:0.40rem;padding-right:0.40rem;border-radius:25px;background-color:${e.tagcolor};${isLightColor(e.tagcolor)?"color: black;":"color: white;"}">${e.tagname}</label><br>\n              `,c.appendChild(t),t=document.createElement("div"),t.classList="col",t.innerHTML=`\n                <input type="checkbox" class="checkbox-round" id="filter-tag-number${e.tagid}" name="filter-tag-number${e.tagid}" value="${e.tagname}">\n                <label for="filter-tag-number${e.tagid}" style="margin-top:5px;white-space:nowrap;cursor:pointer;padding:0.25rem;padding-left:0.40rem;padding-right:0.40rem;border-radius:25px;background-color:${e.tagcolor};${isLightColor(e.tagcolor)?"color: black;":"color: white;"}">${e.tagname}</label><br>\n              `,u.appendChild(t)})),d.style.display="none",d.style.display="block"),updateFilterPage();let g=performance.now();if(console.log(`Client rendering time: ${(g-a).toFixed(3)}ms`),console.log(`Request-to-response performace time: ${(a-e).toFixed(3)}ms`),console.log(`%cRequest-to-finish time: ${(g-e).toFixed(3)}ms`,"color: green;"),!window.data.me.admin){gebi("adduserbutton").setAttribute("hidden","")}gebi("inviteCode").innerHTML=`${window.data.me.userid}`,gebi("inviteCode").onclick=()=>{navigator.clipboard.writeText(window.data.me.userid)},gebi("shareCodeButton").onclick=()=>{navigator.clipboard.writeText(window.data.me.userid),alert("User code copied to your clipboard. Only share with trusted people.")}}}))}let currentEditingTag=null;function renderTagEditor(e){let t=gebi("tagsEditOffcanvas"),a=new bootstrap.Offcanvas(t);t.addEventListener("hide.bs.offcanvas",(()=>{location.reload()})),a.show();let n=gebi("tag2-color");gebi("tag2-delete").onclick=()=>{deleteTag(currentEditingTag)},window.currentTags.forEach((t=>{t.tagid==e&&(gebi("tag2-name").value=t.tagname,n.value=t.tagcolor,n.dispatchEvent(new Event("input",{bubbles:!0})))})),Coloris({parent:gebi("tag2-anchor"),el:gebi("tag2-color"),alpha:!1}),currentEditingTag=e}async function request(e,t=!1,a=!1){openLoading();try{if(t){const t=await fetch("api/"+encodeURIComponent(JSON.stringify(e)),{method:"POST",body:JSON.stringify(a),headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error(`Response status: ${response.status}`);let n=await t.json();return closeLoading(),n}{const t=await fetch("api/"+encodeURIComponent(JSON.stringify(e)),{method:"POST"});if(!t.ok)throw new Error(`Response status: ${response.status}`);let a=await t.json();return closeLoading(),a}}catch(t){closeLoading(),console.error(`Error while handling route ${e}`),console.error(t.message)}}function tryLogin(){request(["login",gebi("login-username").value,gebi("login-password").value]).then((e=>{let t=e.status;if("OK"==t){e.token;storage.write("sessionToken",e.token),storage.write("sessionTokenExpires",e.expires),location.reload()}else"INVALID"==t?alert("The credentials are incorrect, please try again."):(alert("An unexpected error has occurred."),location.reload())})).catch((e=>{alert("An unexpected error has occurred."),console.error(e)}))}Date.prototype.getWeek=function(e){e="number"==typeof e?e:0;var t=new Date(this.getFullYear(),0,1),a=t.getDay()-e;a=a>=0?a:a+7;var n,r=Math.floor((this.getTime()-t.getTime()-6e4*(this.getTimezoneOffset()-t.getTimezoneOffset()))/864e5)+1;return a<4?(n=Math.floor((r+a-1)/7)+1)>52&&(nYear=new Date(this.getFullYear()+1,0,1),nday=nYear.getDay()-e,nday=nday>=0?nday:nday+7,n=nday<4?1:53):n=Math.floor((r+a-1)/7),n};