<!DOCTYPE html>

<!--

TO-DO list app

-->

<html>
  <head>
    <title>Project Echo</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="keywords" content="todo,project,productivity">
    <meta name="author" content="Chen Z/Jason Z">
    <meta name="description" content="Powerful todo list.">

    <!-- BOOTSTRAP -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    
    <!-- GOOGLE FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Parkinsans:wght@300..800&display=swap" rel="stylesheet">
    
    <!-- BUFFER -->
    <script src="bundle.js"></script>

    <style>
      * {
        font-family: "Parkinsans", sans-serif;
      }
      .page {
        display: none;
      }
      .views {
        display: none;
      }
      #profile-menu {
        cursor: pointer;
        padding: 5px;
      }
      #profile-menu:hover {
        border-radius: 20px;
        background-color: #ededed;
      }
      #offcanvas-toggler {
        border:0;
      }
      #logoutButton {
        cursor: pointer;
        color: lightcoral;
      }
      #logoutButton:hover {
        background-color: #ffd7d4;
        border-radius: 5px;
      }
      .nav-item {
        cursor: pointer;
      }
    </style>
  </head>
  <body>

    <!-- pages -->
    <div class="pages">
      <div id="auth" class="container">
        <br>  
        <!-- login block -->
        <div class="card">
          <h5 class="card-header">Login</h5>
          <div class="card-body">
            <form onsubmit="tryLogin();" action="javascript:void(0);">
              <div class="mb-3">
                <label for="login-username" class="form-label">Username</label>
                <input type="text" class="form-control" id="login-username">
              </div>
              <div class="mb-3">
                <label for="login-password" class="form-label">Password</label>
                <input type="password" class="form-control" id="login-password">
              </div>
              <button type="submit" class="btn btn-primary">Login</button>
            </form>
          </div>
        </div>

        <br><br>

        <!-- register block -->
        <div class="card">
          <h5 class="card-header">Don't have an account?</h5>
          <div class="card-body">
            <p>Unfortunately we are in an invite-only private phase. If you do not already have or know your login, there is no way to 
              get access to our service at this time. Please check back for additional updates on our service. Thank you.</p>
          </div>
        </div>

      </div>
      <div id="main-page" class="page">
        <nav class="navbar fixed-bottom bg-body-tertiary">
          <div class="container-fluid">
            <a class="navbar-brand navbar-right" href="#"><b>Project Echo</b>✔️</a>
            <button id="offcanvas-toggler" class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#navbar-offcanvas">
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="offcanvas offcanvas-end" tabindex="-1" id="navbar-offcanvas">
              <div class="offcanvas-header">
                <h5 id="profile-menu" class="offcanvas-title"><img class="self-pfp" style="width:3rem;border-radius:50%;">&nbsp; <span id="greeting">test</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
              </div>
              <div class="offcanvas-body">
                <h6 id="currentVault">Currently viewing: Personal Vault</h6><br>
                <ul class="nav nav-pills flex-column">
                  <li class="nav-item">
                    <a data-bs-dismiss="offcanvas" id="tasks-view-item" class="nav-link active" aria-current="page" onclick="changePage('tasks-view')">Tasks</a>
                  </li>
                  <li class="nav-item">
                    <a data-bs-dismiss="offcanvas" id="vaults-view-item" class="nav-link" onclick="changePage('vaults-view')">Vaults</a>
                  </li>
                  <li class="nav-item">
                    <a data-bs-dismiss="offcanvas" id="tags-view-item" class="nav-link" onclick="changePage('tags-view')">Tags</a>
                  </li>
                  <li class="nav-item">
                    <a data-bs-dismiss="offcanvas" id="people-view-item" class="nav-link" onclick="changePage('people-view')">People</a>
                  </li>
                  <li class="nav-item">
                    <a data-bs-dismiss="offcanvas" id="settings-view-item" class="nav-link" onclick="changePage('settings-view')">Settings</a>
                  </li>
                  <li class="nav-item" id="logoutButton">
                    <a class="nav-link" style="color: lightcoral;">Log Out</a>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </nav>
        <br>
        <div class="container">
          <div>
            <div id="tasks-view">
              <h4>Tasks View</h4>
              <p id="clock-statement">Clock: 8:13pm</p>
              <br>
              <div class="btn-group" role="group">
                
              </div>
            </div>
            <div id="vaults-view" class="views">
              f
            </div>
            <div id="tags-view" class="views">
              d
            </div>
            <div id="people-view" class="views">
              g
            </div>
            <div id="settings-view" class="views">
              b
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>

      window.setInterval(() => {

      }, 1000);

      // Equivalent to NodeJS from buffer.
      const Buffer = deff.Buffer.Buffer;

      let currentPage = 'auth';

      function changePage(newPage){
        if (currentPage != newPage){
          if (currentPage != 'main-view'){
            gebi(currentPage).style.display = 'none';
          }
          gebi(newPage).style.display = 'block';
          // Remove active element class.
          if (newPage.includes('view')){
            gebi(`${currentPage}-item`).classList.remove('active');
            gebi(`${newPage}-item`).classList.add('active');
          }
          currentPage = newPage;
        }
      }

      let storage = {
        write: (key, value) => {
          localStorage.setItem(key, JSON.stringify([value]));
        },
        read: key => {
          if (localStorage.getItem(key) == null){
            return -1;
          }
          return JSON.parse(localStorage.getItem(key))[0];
        },
        delete: key => {
          localStorage.removeItem(key);
        },
        clear: () => {
          localStorage.clear();
        }
      }

      let sessionToken = storage.read('sessionToken');
      if (sessionToken != -1){
        changePage('main-page'); //main menu
        currentPage = 'tasks-view';
        // Update.
        refreshClient();
      }

      function refreshClient(){
        request(['getClientPackageUpdate', sessionToken]).then(data => {
          if (data.status === 'INVALID'){
            storage.clear();
            location.reload();
          }
          else{
            // Set pfp for every location.
            let pd = data.me.pfp;
            console.log(data);
            let fileExt = pd.fileName.split('.')[1];
            let pdEmbedData = `data:image/${fileExt};base64,${Buffer.from(pd.hexData, 'hex').toString('base64')}`
            let doms = document.getElementsByClassName('self-pfp');
            for (let i = 0; i < doms.length; i++){
              let item = doms[i];
              item.src = pdEmbedData;
            }
            // Set greeting.
            gebi('greeting').innerHTML = `Hi, ${data.me.username}`;
          }
        });
      }

      /**
       * Request against the API
       * @param request Object
       * @param params Object
       * @return Object
       */
      async function request(request){
        try {
          const ret = await fetch('api/' + encodeURIComponent(JSON.stringify(request)));
          if (!ret.ok){
            throw new Error(`Response status: ${response.status}`);
          }
          return await ret.json();
        }
        catch (e) {
          //alert('Error in request, see console for details. Please refresh the page.');
          console.error(e.message);
        }
      }

      /**
       * Short getElementById wrapper
       */
      function gebi(id){
        return document.getElementById(id);
      }

      /**
       * Attempt to login and save the auth token.
       */
      function tryLogin(){
        request(['login', gebi('login-username').value, gebi('login-password').value]).then(val => {
          let status = val.status;
          if (status == 'OK'){
            // Let's save the session token.
            let sessionToken = val.token;
            storage.write('sessionToken', val.token);
            storage.write('sessionTokenExpires', val.expires);
            // Reload the page.
            location.reload();
          }
          else if (status == 'INVALID'){
            alert('The credentials are incorrect, please try again.');
          }
          else{
            alert('An unexpected error has occurred.');
            location.reload();
          }
        }).catch(e => {
          alert('An unexpected error has occurred.');
          console.error(e);
        });
      }
    </script>

  </body>
</html>